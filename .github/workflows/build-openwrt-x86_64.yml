#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
# ywt114/free-disk-space@main jlumbroso/free-disk-space
# https://github.com/haiibo/OpenWrt/blob/main/.github/workflows/X86_64-OpenWrt.yml
# https://github.com/FanxJK/OpenWrt-x86_64-Actions/blob/main/.github/workflows/build-openwrt.yml

name: Build OpenWrt x86_64
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: 0x86_64.config
  DIY_P1_SH: 0x86_64-part1.sh
  DIY_P2_SH: 0x86_64-part2.sh
  RELEASE_TAG: x86_64
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  # åˆ é™¤æ— ç”¨æ–‡ä»¶ä»¥å¢žåŠ ç¼–è¯‘ç©ºé—´
  DELETE_USELESS_FILES: false
  # æ£€æŸ¥ç¼–è¯‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  FW_CHECK: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
           
    - name: Check Server Performance
      run: |
        echo "è­¦å‘Šâš "
        echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
        echo -e "å·²çŸ¥CPUåž‹å·(é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
        echo "--------------------------ç³»ç»Ÿä¿¡æ¯--------------------------"
        echo "$(cat /etc/lsb-release)"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
        echo -e "CPUåž‹å·ä¿¡æ¯:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯:"
        echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT
        
    - name: "Optimize disk space"
      if: env.DELETE_USELESS_FILES == 'true' && !cancelled()
      uses: "hugoalh/disk-space-optimizer-ghaction@v0.8.0"
      with:
        operate_sudo: "True"
        general_include: ".+"
        general_exclude: |-
          ^GCC$
          ^G\+\+$
          Clang
          LLVM
        docker_include: ".+"
        docker_prune: "True"
        docker_clean: "True"
        apt_prune: "True"
        apt_clean: "True"
        homebrew_prune: "True"
        homebrew_clean: "True"
        npm_prune: "True"
        npm_clean: "True"
        os_swap: "True"

    - name: Free Disk Space (Ubuntu)
      if: env.DELETE_USELESS_FILES == 'true' && !cancelled()
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Checkout
      uses: actions/checkout@main
      
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        df -hT
        sudo -E apt-get -qq update
        sudo -E apt-get -qq full-upgrade
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gettext gcc-multilib g++-multilib \
        git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev \
        libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev libreadline-dev \
        libssl-dev libtool llvm lrzsz genisoimage msmtp ninja-build p7zip p7zip-full patch pkgconf python3 \
        python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo \
        uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        df -hT

    - name: Clone source code
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        COMMIT_AUTHOR=$(git show -s --date=short --format="ä½œè€…: %an")
        echo "COMMIT_AUTHOR=$COMMIT_AUTHOR" >> $GITHUB_ENV
        COMMIT_DATE=$(git show -s --date=short --format="æ—¶é—´: %ci")
        echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
        COMMIT_MESSAGE=$(git show -s --date=short --format="å†…å®¹: %s")
        echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV
        COMMIT_HASH=$(git show -s --date=short --format="hash: %H")
        echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV

    - name: Generate Variables
      run: |
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å¼ºåˆ¶å¤åˆ¶ï¼Œä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤é…ç½®
        if [ -f "$CONFIG_FILE" ]; then
            cp -f "$CONFIG_FILE" "$OPENWRT_PATH/.config"
            echo "âœ… é…ç½®æ–‡ä»¶ $CONFIG_FILE å·²æˆåŠŸå¤åˆ¶åˆ° $OPENWRT_PATH/.config"
        else
            echo "âš ï¸  é…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤åˆ¶æ“ä½œï¼Œå°†ä½¿ç”¨OpenWrté»˜è®¤é…ç½®"
        fi
        cd $OPENWRT_PATH
        make defconfig > /dev/null 2>&1
        SOURCE_REPO="$(echo $REPO_URL | awk -F '/' '{print $(NF)}')"
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
        DEVICE_TARGET=$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
        echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
        DEVICE_SUBTARGET=$(cat .config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')
        echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV

    - name: Cache
      uses: klever1988/cachewrtbuild@main
      with:
        ccache: 'true'
        mixkey: 'x86_64'
        prefix: 'openwrt'

    - name: Load custom feeds
      run: |
        # æ£€æŸ¥è‡ªå®šä¹‰feedsé…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™æ›¿æ¢
        if [ -f "$FEEDS_CONF" ]; then
            mv -f "$FEEDS_CONF" $OPENWRT_PATH/feeds.conf.default
            echo "âœ… è‡ªå®šä¹‰feedsé…ç½® $FEEDS_CONF å·²æ›¿æ¢ä¸º $OPENWRT_PATH/feeds.conf.default"
        else
            echo "âš ï¸  è‡ªå®šä¹‰feedsé…ç½® $FEEDS_CONF ä¸å­˜åœ¨ï¼Œä½¿ç”¨æºç é»˜è®¤feedsé…ç½®"
        fi
        # æ£€æŸ¥DIY_P1_SHè„šæœ¬æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™èµ‹äºˆæ‰§è¡Œæƒé™å¹¶è¿è¡Œ
        if [ -f "$DIY_P1_SH" ]; then
            chmod +x "$DIY_P1_SH"
            cd $OPENWRT_PATH
            $GITHUB_WORKSPACE/$DIY_P1_SH
            echo "âœ… è‡ªå®šä¹‰è„šæœ¬ $DIY_P1_SH å·²èµ‹äºˆæ‰§è¡Œæƒé™å¹¶æˆåŠŸè¿è¡Œ"
        else
            echo "âš ï¸  è‡ªå®šä¹‰è„šæœ¬ $DIY_P1_SH ä¸å­˜åœ¨ï¼Œè·³è¿‡è„šæœ¬æ‰§è¡Œ"
        fi
        df -hT

    - name: Update feeds
      run: cd $OPENWRT_PATH && ./scripts/feeds update -a

    - name: Install feeds
      run: cd $OPENWRT_PATH && ./scripts/feeds install -a

    - name: Openwrt AutoUpdate
      run: |
        TEMP=$(date +"OpenWrt_x86_64_%Y%m%d_%H%M%S_")$(git rev-parse --short HEAD)
        echo "RELEASE_TAG=$TEMP" >> $GITHUB_ENV
        # Add DISTRIB_GITHUB to openwrt_release
        sed -i "/DISTRIB_DESCRIPTION=/a\sed -i '/DISTRIB_GITHUB/d' /etc/openwrt_release" $OPENWRT_PATH/package/lean/default-settings/files/zzz-default-settings
        sed -i "/DISTRIB_GITHUB/a\echo \"DISTRIB_GITHUB=\'https://github.com/${{github.repository}}\'\" >> /etc/openwrt_release" $OPENWRT_PATH/package/lean/default-settings/files/zzz-default-settings
        # Add DISTRIB_VERSIONS to openwrt_release
        sed -i "/DISTRIB_DESCRIPTION=/a\sed -i '/DISTRIB_VERSIONS/d' /etc/openwrt_release" $OPENWRT_PATH/package/lean/default-settings/files/zzz-default-settings
        sed -i "/DISTRIB_VERSIONS/a\echo \"DISTRIB_VERSIONS=\'${TEMP:8}\'\" >> /etc/openwrt_release" $OPENWRT_PATH/package/lean/default-settings/files/zzz-default-settings
        # Modify DISTRIB_DESCRIPTION
        sed -i "s/OpenWrt /${{github.actor}} compiled (${TEMP:8}) \/ OpenWrt /g" $OPENWRT_PATH/package/lean/default-settings/files/zzz-default-settings

    - name: Load custom configuration
      run: |
        # æ£€æŸ¥è‡ªå®šä¹‰filesç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ç§»åŠ¨
        if [ -d "files" ]; then
            mv -f "files" "$OPENWRT_PATH/files"
            echo "âœ… è‡ªå®šä¹‰filesç›®å½•å·²æˆåŠŸç§»åŠ¨åˆ° $OPENWRT_PATH/files"
        else
            echo "âš ï¸  è‡ªå®šä¹‰filesç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡ç›®å½•ç§»åŠ¨"
        fi
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™é‡æ–°è¦†ç›–
        if [ -f "$CONFIG_FILE" ]; then
            mv -f "$CONFIG_FILE" "$OPENWRT_PATH/.config"
            echo "âœ… é…ç½®æ–‡ä»¶ $CONFIG_FILE å·²é‡æ–°è¦†ç›–åˆ° $OPENWRT_PATH/.config"
        else
            echo "âš ï¸  é…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼Œè·³è¿‡é‡æ–°è¦†ç›–"
        fi
        # æ£€æŸ¥DIY_P2_SHè„šæœ¬æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™èµ‹æƒå¹¶æ‰§è¡Œ
        if [ -f "$DIY_P2_SH" ]; then
            chmod +x "$DIY_P2_SH"
            cd $OPENWRT_PATH
            $GITHUB_WORKSPACE/$DIY_P2_SH
            echo "âœ… è‡ªå®šä¹‰è„šæœ¬ $DIY_P2_SH å·²èµ‹äºˆæ‰§è¡Œæƒé™å¹¶æˆåŠŸè¿è¡Œ"
        else
            echo "âš ï¸  è‡ªå®šä¹‰è„šæœ¬ $DIY_P2_SH ä¸å­˜åœ¨ï¼Œè·³è¿‡è„šæœ¬æ‰§è¡Œ"
        fi

    - name: SSH connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: Download package
      id: package
      run: |
        cd $OPENWRT_PATH
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile the firmware
      id: compile
      run: |
        df -hT $PWD
        cd $OPENWRT_PATH
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j8 || make -j8 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "======================="
        echo "Space usage:"
        echo "======================="
        df -h
        echo "======================="
        du -h --max-depth=1 ./ --exclude=build_dir --exclude=bin
        du -h --max-depth=1 ./build_dir
        du -h --max-depth=1 ./bin

    - name: Check space usage
      if: (!cancelled())
      run: |
        df -hT

    - name: Check firmware existence 
      if: env.FW_CHECK == 'true' && !cancelled()
      id: fw_check
      run: |
        set -euo pipefail
        shopt -s globstar nullglob
        # æ£€æŸ¥æŒ‡å®šæ–‡ä»¶ï¼Œä»»æ„ä¸€ä¸ªå­˜åœ¨å³é€šè¿‡
        firmware_files=($OPENWRT_PATH/bin/targets/**/**/*.buildinfo $OPENWRT_PATH/bin/targets/**/**/*.manifest $OPENWRT_PATH/bin/targets/**/**/*kernel.bin $OPENWRT_PATH/bin/targets/**/**/*rootfs.img.gz $OPENWRT_PATH/bin/targets/**/**/profiles.json $OPENWRT_PATH/bin/targets/**/**/sha256sums)
        if [ ${#firmware_files[@]} -gt 0 ]; then
        echo "firmware_exists=true" >> "$GITHUB_OUTPUT"
        echo "firmware_candidates=${firmware_files[*]}" >> "$GITHUB_OUTPUT"
        else
        echo "firmware_exists=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Upload bin directory
      uses: actions/upload-artifact@main
      if: steps.fw_check.outputs.firmware_exists == 'true' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
      with:
        name: ${{ env.SOURCE_REPO }}-bin-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin

    - name: Organize files
      id: organize
      if: steps.fw_check.outputs.firmware_exists == 'true' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd $OPENWRT_PATH/bin/targets/*/*
        cat sha256sums
        cp $OPENWRT_PATH/.config build.config
        KERNEL=$(cat *.manifest | grep ^kernel | cut -d- -f2 | tr -d ' ' 2>/dev/null || echo "unknown")
        echo "KERNEL=$KERNEL" >> $GITHUB_ENV
        if [ -d $OPENWRT_PATH/bin/packages ]; then
          mv -f $OPENWRT_PATH/bin/packages/*/*/*.ipk packages/ 2>/dev/null || true
          tar -zcf Packages.tar.gz packages/ 2>/dev/null || true
        fi
        # åˆ é™¤æ— å…³æ–‡ä»¶
        rm -rf packages *.buildinfo *.manifest *kernel.bin *rootfs.img.gz profiles.json sha256sums 2>/dev/null || true
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      with:
        name: ${{ env.SOURCE_REPO }}-firmware-${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: Upload firmware to cowtransfer
      id: cowtransfer
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
        echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
        echo "url=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

    - name: Upload firmware to WeTransfer
      id: wetransfer
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
        echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
        echo "url=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

    - name: Generate release tag
      id: tag
      if: steps.fw_check.outputs.firmware_exists == 'true' && steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        df -hT $PWD
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        touch release.txt
        echo "**This is OpenWrt Firmware for ${{ env.RELEASE_TAG }}**" >> release.txt
        echo "  ### å›ºä»¶ä¿¡æ¯" >> release.txt
        echo "  - å¹³å°æž¶æž„: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}" >> release.txt
        echo "  - å›ºä»¶æºç : ${{ env.REPO_URL }}" >> release.txt
        echo "  - æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}" >> release.txt
        echo "  - å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL }}" >> release.txt
        echo "  - é»˜è®¤åœ°å€: 192.168.1.1" >> release.txt
        echo "  - é»˜è®¤å¯†ç : password" >> release.txt
        
        # ä¸»è¦æ›´æ–°æ¿å—ï¼Œè¯»å–.github/CHANGELOG.txtå†…å®¹
        echo "  ### ä¸»è¦æ›´æ–°" >> release.txt
        # æ£€æŸ¥CHANGELOG.txtæ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™è¯»å–å†…å®¹ï¼Œä¸å­˜åœ¨åˆ™æ˜¾ç¤ºé»˜è®¤æç¤º
        if [ -f "$GITHUB_WORKSPACE/.github/CHANGELOG.txt" ]; then
            cat "$GITHUB_WORKSPACE/.github/CHANGELOG.txt" >> release.txt
        else
            echo "  æš‚æ— è‡ªå®šä¹‰æ›´æ–°è¯´æ˜Ž" >> release.txt
        fi
        
        # ä¸»ç¨‹åºä¿¡æ¯æ¿å—ï¼ˆåŽŸå›ºä»¶ç‰ˆæœ¬ï¼‰
        echo "  ### ä¸»ç¨‹åºä¿¡æ¯" >> release.txt
        echo "  - å›ºä»¶ç¼–è¯‘å‰æœ€åŽä¸€æ¬¡âž¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•" >> release.txt
        echo "  - ${{ env.COMMIT_AUTHOR }}" >> release.txt
        echo "  - ${{ env.COMMIT_DATE }}" >> release.txt
        # ä¿æŒCOMMIT_HASHåœ¨å‰ã€COMMIT_MESSAGEåœ¨åŽçš„é¡ºåº
        echo "  - ${{ env.COMMIT_HASH }}" >> release.txt
        echo "  - ${{ env.COMMIT_MESSAGE }}" >> release.txt
        git -C $OPENWRT_PATH log --pretty=format:"%s(#By %an)"  --graph --since=168.hour >> release.txt
        [ $UPLOAD_COWTRANSFER = true ] && echo "ðŸ”— [Cowtransfer](${{ steps.cowtransfer.outputs.url }})" >> release.txt
        [ $UPLOAD_WETRANSFER = true ] && echo "ðŸ”— [WeTransfer](${{ steps.wetransfer.outputs.url }})" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.RELEASE_TAG }}-${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: Delete workflow runs
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 30
        keep_minimum_runs: 9

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@v0.1.0
      if: steps.tag.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 9
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
